import Code from '../../../components/Code.jsx';

# Upload de Arquivo

![](/imgs/upload-file/foods-app.png)

## Database

src/database/migration.js:

<Code src="https://raw.githubusercontent.com/lucachaves/lp2-classroom-2022/upload-file/src/database/migration.js" lang="js" />

src/database/seeders.json:

<Code src="https://raw.githubusercontent.com/lucachaves/lp2-classroom-2022/upload-file/src/database/seeders.json" lang="json" />

src/models/Food.js:

<Code src="https://raw.githubusercontent.com/lucachaves/lp2-classroom-2022/upload-file/src/models/Food.js" lang="js" />

## Back-end

```txt
$ npm install multer
```

.env.example:

<Code src="https://raw.githubusercontent.com/lucachaves/lp2-classroom-2022/upload-file/.env.example" lang="js" />

src/config/multer.js:

<Code src="https://raw.githubusercontent.com/lucachaves/lp2-classroom-2022/upload-file/src/config/multer.js" lang="js" />

src/routes.js:

```js
import { Router } from 'express';
import jwt from 'jsonwebtoken';
import bcrypt from 'bcryptjs';
import multer from 'multer';

import uploadConfig from './config/multer.js';
import Category from './models/Category.js';
import Food from './models/Food.js';
import User from './models/User.js';

...

router.post(
  '/foods',
  isAuthenticated,
  multer(uploadConfig).single('image'),
  async (req, res) => {
    try {
      const food = req.body;

      const image = req.file
        ? `/imgs/foods/${req.file.filename}`
        : '/imgs/foods/placeholder.jpg';

      const newFood = await Food.create({ ...food, image });

      res.json(newFood);
    } catch (error) {
      throw new Error('Error in create food');
    }
  }
);

router.put(
  '/foods/:id',
  isAuthenticated,
  multer(uploadConfig).single('image'),
  async (req, res) => {
    try {
      const id = Number(req.params.id);

      const food = req.body;

      const image = req.file
        ? `/imgs/foods/${req.file.filename}`
        : '/imgs/foods/placeholder.jpg';

      const newFood = await Food.update({ ...food, image }, id);

      if (newFood) {
        res.json(newFood);
      } else {
        res.status(400).json({ error: 'Food not found.' });
      }
    } catch (error) {
      throw new Error('Error in update food');
    }
  }
);

...

```

src/index.js:

```js
...

const app = express();

app.use(express.json());

app.use(express.urlencoded({ extended: true }));

...
```

request.http:

```js
...

### Create Food with image

POST {{host}}/foods
Authorization: bearer {{token}}
Content-Type: multipart/form-data; boundary="boundary"

--boundary
Content-Disposition: form-data; name="name"

Milkshake
--boundary
Content-Disposition: form-data; name="price"

12.5
--boundary
Content-Disposition: form-data; name="category_id"

2
--boundary
Content-Disposition: form-data; name="image"; filename="milkshake.jpg"
Content-Type: image/jpeg

< ./public/imgs/foods/milkshake.jpg
--boundary--

...
```

## Font-end

![](/imgs/upload-file/food-form.png)

public/foods.html:

<Code src="https://raw.githubusercontent.com/lucachaves/lp2-classroom-2022/upload-file/public/foods.html" lang="html" />
